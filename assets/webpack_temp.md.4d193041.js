import{_ as s,c as n,o as a,a as l}from"./app.0d9042f1.js";const F=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[{"level":2,"title":"let -> var","slug":"let-var","link":"#let-var","children":[]},{"level":2,"title":"将代码转es5","slug":"将代码转es5","link":"#将代码转es5","children":[]},{"level":2,"title":"依赖分析","slug":"依赖分析","link":"#依赖分析","children":[{"level":3,"title":"递归地分析嵌套依赖","slug":"递归地分析嵌套依赖","link":"#递归地分析嵌套依赖","children":[]},{"level":3,"title":"循环依赖，导致调用栈溢出","slug":"循环依赖-导致调用栈溢出","link":"#循环依赖-导致调用栈溢出","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]},{"level":2,"title":"AST相关","slug":"ast相关","link":"#ast相关","children":[]},{"level":2,"title":"打包器 bundler  bundle打包","slug":"打包器-bundler-bundle打包","link":"#打包器-bundler-bundle打包","children":[{"level":3,"title":"编译import export 关键字","slug":"编译import-export-关键字","link":"#编译import-export-关键字","children":[]},{"level":3,"title":"待完成","slug":"待完成","link":"#待完成","children":[]}]},{"level":2,"title":"Loader","slug":"loader","link":"#loader","children":[]},{"level":2,"title":"源码 学习","slug":"源码-学习","link":"#源码-学习","children":[{"level":3,"title":"看源码，带着问题看","slug":"看源码-带着问题看","link":"#看源码-带着问题看","children":[]},{"level":3,"title":"总结","slug":"总结-1","link":"#总结-1","children":[]}]},{"level":2,"title":"Plugin","slug":"plugin","link":"#plugin","children":[{"level":3,"title":"imagemin-webpack-plugin","slug":"imagemin-webpack-plugin","link":"#imagemin-webpack-plugin","children":[]},{"level":3,"title":"clean-webpack-plugin","slug":"clean-webpack-plugin","link":"#clean-webpack-plugin","children":[]},{"level":3,"title":"providePlugin","slug":"provideplugin","link":"#provideplugin","children":[]},{"level":3,"title":"Loader 和 plugin区别 ？","slug":"loader-和-plugin区别","link":"#loader-和-plugin区别","children":[]},{"level":3,"title":"自己写webpack plugin","slug":"自己写webpack-plugin","link":"#自己写webpack-plugin","children":[]}]}],"relativePath":"webpack/temp.md"}'),p={name:"webpack/temp.md"},e=l(`<p>少量代码 大量思考 看 做 练 写 忘 多看几遍</p><h2 id="let-var" tabindex="-1">let -&gt; var <a class="header-anchor" href="#let-var" aria-hidden="true">#</a></h2><p>code -&gt; Ast -&gt; code2</p><ol><li>初始化模块</li></ol><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">dependencies</span></span>
<span class="line"><span style="color:#A6ACCD;">    @babel/core</span></span>
<span class="line"><span style="color:#A6ACCD;">    @babel/generator</span></span>
<span class="line"><span style="color:#A6ACCD;">    @babel/parser</span></span>
<span class="line"><span style="color:#A6ACCD;">    @babel/preset-env</span></span>
<span class="line"><span style="color:#A6ACCD;">    @babel/traverse</span></span>
<span class="line"><span style="color:#A6ACCD;">devDe</span></span>
<span class="line"><span style="color:#A6ACCD;">    @types/babel__core</span></span>
<span class="line"><span style="color:#A6ACCD;">    @types/babel__traverse</span></span>
<span class="line"><span style="color:#A6ACCD;">    @types/generator</span></span>
<span class="line"><span style="color:#A6ACCD;">    @types/preset-env</span></span>
<span class="line"><span style="color:#A6ACCD;">    @types/node</span></span>
<span class="line"><span style="color:#A6ACCD;">    ts-node</span></span>
<span class="line"><span style="color:#A6ACCD;">    typescript</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">启动 node -r ts-node/register --inspect-brk let_to_var.ts </span></span>
<span class="line"><span style="color:#A6ACCD;">结合Chrome开发者工具的调试 chrome://inspect</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li>代码</li></ol><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">parse</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@babel/parser</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> traverse </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@babel/traverse</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> generate </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@babel/generator</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> code </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">let a = &#39;let&#39;; let b = 2</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> ast </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parse</span><span style="color:#A6ACCD;">(code</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">sourceType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(ast)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">ast</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">program</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">body</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forEach</span><span style="color:#A6ACCD;">(</span><span style="color:#A6ACCD;font-style:italic;">item</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">item</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">variableDeclaration</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">item</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">kind</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">let</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">item</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">kind</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">var</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">generator</span><span style="color:#A6ACCD;">(ast</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#A6ACCD;"> code)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li>用 chrome调试 调试node代码</li><li>查看ast, VariableDeclaration</li></ol><h2 id="将代码转es5" tabindex="-1">将代码转es5 <a class="header-anchor" href="#将代码转es5" aria-hidden="true">#</a></h2><p>AST 用正侧不容易匹配替换完 自动转es5,借助插件preset-env</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> babel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">transformFromAstSync</span><span style="color:#A6ACCD;">(ast</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> code</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">presets</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@babel/preset-env</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>利用node fs模块，读写文件，转义文件内的代码</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> code </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readFileSync</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./test.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> ast </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parse</span><span style="color:#A6ACCD;">(code</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">sourceType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> babel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">transformFromAstSync</span><span style="color:#A6ACCD;">(ast</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> code</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">presets</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@babel/preset-env</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">writeFileSync</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./test.es5.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">code)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="依赖分析" tabindex="-1">依赖分析 <a class="header-anchor" href="#依赖分析" aria-hidden="true">#</a></h2><p>例子</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">project_1/index.js</span></span>
<span class="line"><span style="color:#A6ACCD;">import a from &#39;./a.js&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">import b from &#39;./b.js&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">console.log(a.value, b.value)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">project_1/a.js</span></span>
<span class="line"><span style="color:#A6ACCD;">const a = { value: 1 }</span></span>
<span class="line"><span style="color:#A6ACCD;">export default a</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">project_1/b.js</span></span>
<span class="line"><span style="color:#A6ACCD;">const b = { value: 2 }</span></span>
<span class="line"><span style="color:#A6ACCD;">export default b</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">执行deps_1.ts,打印出关系</span></span>
<span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;index.js&#39;: {</span></span>
<span class="line"><span style="color:#A6ACCD;">        deps: [&#39;a.js&#39;, &#39;b.js&#39;],</span></span>
<span class="line"><span style="color:#A6ACCD;">        code: 文件源码</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>主要是fs模块，以及ImportDeclaration 判断是不是引入依赖语句</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">deps_2.ts</span></span>
<span class="line"><span style="color:#A6ACCD;">import { parse } form &#39;@babel/parser&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">import traverse from &#39;@babel/traverse&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">import { readFileSync } from &#39;fs&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">import { resolve, relative, dirname } from &#39;path&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">// 设置根目录</span></span>
<span class="line"><span style="color:#A6ACCD;">const prjRoot = resolve(__dirname, &#39;project_1&#39;)</span></span>
<span class="line"><span style="color:#A6ACCD;">// 类型声明</span></span>
<span class="line"><span style="color:#A6ACCD;">type DepRelation = { [key: string]: { deps: string[], code: string } }</span></span>
<span class="line"><span style="color:#A6ACCD;">// 初始化一个空的 depRelation ,用于收集数据</span></span>
<span class="line"><span style="color:#A6ACCD;">const depRelation: DepRelation = {}</span></span>
<span class="line"><span style="color:#A6ACCD;">// 将入口文件的绝对函数传参，</span></span>
<span class="line"><span style="color:#A6ACCD;">collectCodeAndDeps(resolve(prjRoot, &#39;index.js&#39;))</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">log(depRelation)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">function collectCodeAndDeps(filePath) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // 获取传入路径的文件名</span></span>
<span class="line"><span style="color:#A6ACCD;">    const key = getProjectPath(filePath) </span></span>
<span class="line"><span style="color:#A6ACCD;">    const code = readFileSync(filePath).toString()</span></span>
<span class="line"><span style="color:#A6ACCD;">    // 初始化</span></span>
<span class="line"><span style="color:#A6ACCD;">    depRelation[key] = { deps: [], code: code }</span></span>
<span class="line"><span style="color:#A6ACCD;">    // 传代码 code -&gt; ast</span></span>
<span class="line"><span style="color:#A6ACCD;">    const ast = parse(code, { sourceType: &#39;module&#39; })</span></span>
<span class="line"><span style="color:#A6ACCD;">    traverse(ast, {</span></span>
<span class="line"><span style="color:#A6ACCD;">        enter: (path) =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">            if(path.node.type === &#39;ImportDeclaration&#39;) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                // 拼接出依赖的绝对路径</span></span>
<span class="line"><span style="color:#A6ACCD;">                const depAbsoultePath = resolve(dirname(filepath), path.node.source.value)</span></span>
<span class="line"><span style="color:#A6ACCD;">                // 转为项目路径</span></span>
<span class="line"><span style="color:#A6ACCD;">                const depProjectPath = getProjectPath(depAbsoultePath)</span></span>
<span class="line"><span style="color:#A6ACCD;">                // 把依赖写进 depRelation</span></span>
<span class="line"><span style="color:#A6ACCD;">                depRelation[key].deps.push(depProjectPath)</span></span>
<span class="line"><span style="color:#A6ACCD;">                collectCodeAndDeps(depAbsoultePath) // 递归分析嵌套依赖</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    })</span></span>
<span class="line"><span style="color:#A6ACCD;">} </span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">function getProjectPath() {}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="递归地分析嵌套依赖" tabindex="-1">递归地分析嵌套依赖 <a class="header-anchor" href="#递归地分析嵌套依赖" aria-hidden="true">#</a></h3><p>一层一层往下找依赖关系，可能存在call stack风险，因为依赖层级超过1w。</p><h3 id="循环依赖-导致调用栈溢出" tabindex="-1">循环依赖，导致调用栈溢出 <a class="header-anchor" href="#循环依赖-导致调用栈溢出" aria-hidden="true">#</a></h3><p>要处理这种情况，跟递归差不多，记录已经分析过的文件，分析过的直接return就好，因为目前只是分析文件中的依赖关系，不执行代码。由于分析文件不执行代码，则叫静态分析。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h2><ol><li><p>AST相关</p></li><li><p>工具</p></li><li><p>代码技巧 使用哈希表存数据 检测Key来避免重复</p></li><li><p>循环依赖 有的循环依赖可以正常执行 有的循环依赖不可以 但都可以做静态分析</p></li></ol><p>最后可以分析出一个文件里面的依赖</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">depRelation: {</span></span>
<span class="line"><span style="color:#A6ACCD;">	&#39;index.js&#39;: {</span></span>
<span class="line"><span style="color:#A6ACCD;">		deps: [&#39;a.js&#39;, &#39;b.js&#39;],</span></span>
<span class="line"><span style="color:#A6ACCD;">		code: \`import a from &#39;./a.js&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">		import b from &#39;./b.js&#39; ...\`</span></span>
<span class="line"><span style="color:#A6ACCD;">	},</span></span>
<span class="line"><span style="color:#A6ACCD;">	&#39;a.js&#39;: {</span></span>
<span class="line"><span style="color:#A6ACCD;">		deps:[&#39;b.js&#39;],</span></span>
<span class="line"><span style="color:#A6ACCD;">		code: &#39;...&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">	}</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="ast相关" tabindex="-1">AST相关 <a class="header-anchor" href="#ast相关" aria-hidden="true">#</a></h2><ol><li>parse： 把代码code 变成 AST</li><li>traverse: 遍历ast 进行修改</li><li>generate： 把ast变成代码code2</li></ol><h2 id="打包器-bundler-bundle打包" tabindex="-1">打包器 bundler bundle打包 <a class="header-anchor" href="#打包器-bundler-bundle打包" aria-hidden="true">#</a></h2><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">1. 浏览器不支持直接运行带有 import 和 export 关键字的代码，报 Uncaught SyntaxError: Cannot use import statement outside a module 错误。</span></span>
<span class="line"><span style="color:#A6ACCD;">2. 现代浏览器可以通过 </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 来支持import export ，但IE 8 - 15不支持import export。</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">scr</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">index.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>激进的兼容策略：不支持IE,而且直接用import导致文件请求过多。</strong></p><p><strong>平缓的兼容策略：将关键字转译为普通代码，并把所有文件打包成一个文件。</strong></p><ol><li>转译为es5代码，把import /export变为函数；</li><li>打包成一个文件。</li></ol><p>import export 转函数，需要了解编译原理，但babel/core帮我们解决了，直接调用对应的函数就可以。</p><p><strong>本质上：ESModule 语法 变成了 CommonJS规则</strong></p><ol><li>将全部依赖关系文件打包成一个文件</li><li>将es6的import export 语法转为 common.js语法， require exports</li></ol><h3 id="编译import-export-关键字" tabindex="-1">编译import export 关键字 <a class="header-anchor" href="#编译import-export-关键字" aria-hidden="true">#</a></h3><p>code -&gt; es5Code -&gt; ast -&gt; code2</p><p>过程用到的关键语法</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">nodeJs 的读写</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">readFileSync</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">resolve</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">relative</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dirname</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> code </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">readFileSync</span><span style="color:#A6ACCD;">(filepath)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">code </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> es5Code  把import转为require，export转为exports</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> babel </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@babel/core</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">code</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> es5Code </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> babel</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">transform</span><span style="color:#A6ACCD;">(code</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F07178;">presets</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@babel/preset-env</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">es5Code </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> ast</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">parse</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@babel/parser</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;"> </span><span style="color:#676E95;font-style:italic;">// 将代码转为 AST</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> ast </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">parse</span><span style="color:#A6ACCD;">(es5Code</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">sourceType</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">module</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">ast </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> code2 </span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> traverse </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@babel/traverse</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">traverse</span><span style="color:#A6ACCD;">(ast</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">enter</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ImportDeclaration</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// path.node.source.value 往往是一个相对路径，如 ./a.js，需要先把它转为一个绝对路径</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">depAbsolutePath</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">dirname</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">filepath</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">node</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 然后转为项目路径</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">depProjectPath</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">getProjectPath</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">depAbsolutePath</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 把依赖写进 depRelation</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">depRelation</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">depProjectPath</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">collectCodeAndDeps</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">depAbsolutePath</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)  </span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol><li><p>从入口文件出发，分析出引用到的文件的依赖；</p></li><li><p>不仅分析出依赖关系，还将es5Code收集起来；</p></li><li><p>参考webpack打包后的dist文件，添加一些头尾，生成最终打包出来的代码，将import export module形式改为commonJs形式</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">gtp</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">esModule 和 CommonJS 都是用于在 JavaScript 中导出和导入模块的机制，但它们的语法和行为有所不同。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">ES modules 是 ECMAScript 标准中定义的一种模块系统，使用 </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> 和 export 关键字来导入和导出模块。这种机制可以在浏览器端和 Node.js 环境下使用，支持静态分析、动态加载和 Tree-shaking 等特性。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">CommonJS 是 Node.js 最初采用的一种模块规范，使用 require() 和 module.exports 来导入和导出模块。相比 ES modules，它的语法更加简单直观，但不支持动态导入和 Tree-shaking。</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">总的来说，如果你要开发运行在现代浏览器中的应用程序或库，建议使用 ES modules；如果你要编写运行在 Node.js 环境下的代码，可以使用 CommonJS 或 ES modules（Node.js 支持两种规范）；如果你需要同时支持浏览器和 Node.js 环境，可以使用打包工具将 ES modules 转换为 CommonJS 或者 AMD 规范。</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>require 一个文件，就是执行一个文件的代码。</p><p>excute 就是把某个文件的代码挂载出来，然后执行</p></li></ol><p>code -&gt; es5Code 把import/export 转为require/ exports函数。</p><p>然后转ast,对语法进行降级，因为要重新写code2, 先要转ast才能转code2，</p><p>然后转译之后，要考虑怎么把这个代码封装好，符合CommonJs2的规范，保证最后代码能够执行，</p><p>所以还需要自己加代码进行处理</p><h4 id="最终目标" tabindex="-1">最终目标 <a class="header-anchor" href="#最终目标" aria-hidden="true">#</a></h4><p>对于<strong>bunder</strong>来说，这些都是字符串，我们要做的事拼接字符串，满足最后我们的打包目标</p><ol><li>转译文件，import/export 转为 require exports</li><li>合并成一个文件，拼接字符串<strong>generateCode</strong>，最后写文件</li></ol><p>打包出来需要包含</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">var depRelation = [</span></span>
<span class="line"><span style="color:#A6ACCD;">	{ key: &#39;index.js&#39;, deps: [&#39;a.js&#39;, &#39;b.js&#39;], code: function... },</span></span>
<span class="line"><span style="color:#A6ACCD;">	{ key: &#39;a.js&#39;, deps: [&#39;b.js&#39;], code: function... }</span></span>
<span class="line"><span style="color:#A6ACCD;">	{ key: &#39;b.js&#39;, deps: [&#39;a.js&#39;], code: function... }</span></span>
<span class="line"><span style="color:#A6ACCD;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">code里面是key文件对应的代码</span></span>
<span class="line"><span style="color:#A6ACCD;">var modules = {} 缓存所有执行过的模块</span></span>
<span class="line"><span style="color:#A6ACCD;">excute(depRelation[0].key)</span></span>
<span class="line"><span style="color:#A6ACCD;">function excute(key) {</span></span>
<span class="line"><span style="color:#A6ACCD;">	var require = ...</span></span>
<span class="line"><span style="color:#A6ACCD;">	var module = ...</span></span>
<span class="line"><span style="color:#A6ACCD;">	var item = depRelation.find...</span></span>
<span class="line"><span style="color:#A6ACCD;">	item.code(require, module, module.exports) // module是以前要求要的，现在没啥用了，但还是要有</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="待完成" tabindex="-1">待完成 <a class="header-anchor" href="#待完成" aria-hidden="true">#</a></h3><ol><li>bundler1 code -&gt; es5Code</li></ol><p>code -&gt; es5Code 的代码</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js源码</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> a </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./a.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> b </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">b</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">getA</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> a</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> from b.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> b</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;">/export 转译为 require/exports函数</span></span>
<span class="line"><span style="color:#A6ACCD;">b.js代码</span></span>
<span class="line"><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">use strict</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">Object.defineProperty(exports</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">__esModule</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">: </span><span style="color:#A6ACCD;">true</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">);                                       </span></span>
<span class="line"><span style="color:#A6ACCD;">===&gt; const exports = </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">__esModule</span><span style="color:#F07178;">: </span><span style="color:#A6ACCD;">true</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                                      </span></span>
<span class="line"><span style="color:#A6ACCD;">exports[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">] = void 0; </span></span>
<span class="line"><span style="color:#A6ACCD;">===&gt; const exports = </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">__esModule</span><span style="color:#F07178;">: </span><span style="color:#A6ACCD;">true</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#F07178;">: </span><span style="color:#A6ACCD;">undefined</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">                                      </span></span>
<span class="line"><span style="color:#A6ACCD;">var _a = _interopRequireDefault(require(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./a.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">function _interopRequireDefault(obj) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">obj</span><span style="color:#F07178;"> &amp;&amp; </span><span style="color:#A6ACCD;">obj</span><span style="color:#F07178;">.</span><span style="color:#A6ACCD;">__esModule</span><span style="color:#F07178;"> ? </span><span style="color:#A6ACCD;">obj</span><span style="color:#F07178;"> : { &quot;</span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#F07178;">&quot;: </span><span style="color:#A6ACCD;">obj</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">var b = </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">: &#39;</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">getA</span><span style="color:#F07178;">: </span><span style="color:#A6ACCD;">function</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getA</span><span style="color:#F07178;">() {</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">_a</span><span style="color:#F07178;">[&quot;</span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#F07178;">&quot;].</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> + &#39; </span><span style="color:#A6ACCD;">from</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;">.</span><span style="color:#A6ACCD;">js</span><span style="color:#F07178;">&#39;;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">                                      </span></span>
<span class="line"><span style="color:#A6ACCD;">var _default = b;</span></span>
<span class="line"><span style="color:#A6ACCD;">exports[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">default</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">] = _default;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>已转译，接下来就是怎么打包到一个文件内，需要增加额外代码进行支持。</p><p>个人想法： import或者require就是引入并执行一个文件，最后输出export/module.exports上挂载的东西，</p><p>所以配套使用。</p><p>EsModule 和CommonJs，主要是语法和行为上的差异，语法上ESModule，是ECMAScript定义的一个一个模块系统，用import/export关键字，并支持静态分析、动态导入和TreeShaking</p><p>而CommonJs是NodeJs最初定义的一套模块系统，语法用require/module.exports</p><p>现代浏览器支持EsModule,需要script标签内用 type=&quot;module&quot;，IE不支持。</p><h2 id="loader" tabindex="-1">Loader <a class="header-anchor" href="#loader" aria-hidden="true">#</a></h2><p>上节课封装的bundler不支持css</p><p>关键： 把css转为js。js文件中共，css文件代码转为字符串，然后在写入的时候，用dom操作，添加到html文件中。</p><p>注意：css中会有属性选择器，会有双引号，如果直接用<code>&quot;\${code}&quot;</code>反引号+双引号进行包裹的话，最后写的文件会出问题，所以用**<code>\${JSON.stringify(code)}</code>**,JSON.stringify会对双引号进行转义。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">\\.</span><span style="color:#C3E88D;">css</span><span style="color:#89DDFF;font-style:italic;">$</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#A6ACCD;">(path)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">const str = </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#A6ACCD;">(code)</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C3E88D;">		if(document) {</span></span>
<span class="line"><span style="color:#C3E88D;">			const style = document.createElement(&#39;style&#39;)</span></span>
<span class="line"><span style="color:#C3E88D;">			style.innerHTML = str</span></span>
<span class="line"><span style="color:#C3E88D;">			document.head.appendChild(style)</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#C3E88D;">export default str</span></span>
<span class="line"><span style="color:#C3E88D;">	</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>loader可以是一个函数，</p><p>css-loader 就是把上面的代码单独封装在一个文件里面，导出方法</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">css</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">loader</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> transform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">code</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#C3E88D;">	const str = </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#A6ACCD;">(code)</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C3E88D;">	if(document) {</span></span>
<span class="line"><span style="color:#C3E88D;">const style = document.createElement(&#39;style&#39;)</span></span>
<span class="line"><span style="color:#C3E88D;">style.innerHTML = str</span></span>
<span class="line"><span style="color:#C3E88D;">document.head.appendChild(style)</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#C3E88D;">export default str</span></span>
<span class="line"><span style="color:#89DDFF;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">module.exports</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transform</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">bundler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ts</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">\\.</span><span style="color:#C3E88D;">css</span><span style="color:#89DDFF;font-style:italic;">$</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#A6ACCD;">(path)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">require</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./css-loader.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)(</span><span style="color:#A6ACCD;">code</span><span style="color:#F07178;">)   </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>单一职责原则</p><p>webpack里每个loader只做一件事，方便组合。</p><p>而上面的代码做了两件事，第一是css-&gt;js， 第二是添加到head里面。拆分为css-loader、style-loader。但我们无法实现style-loader，因为style-loader是插入代码，需要寻找插入时机和插入位置。</p><p>如果是sassLoader,lessLoader -&gt; cssLoader 这样过程一直是转译，但style-loader是接收到css-loader transform后的代码，并添加插入逻辑。</p><p>拆分后的代码</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">css</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">loader </span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> tranform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">code</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#C3E88D;">	const str = </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#A6ACCD;">(code)</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C3E88D;">	export default str</span></span>
<span class="line"><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">module.exports</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">stule</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">loader</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> tranform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">code</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">code</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C3E88D;">	if(document) {</span></span>
<span class="line"><span style="color:#C3E88D;">const style = document.createElement(&#39;style&#39;)</span></span>
<span class="line"><span style="color:#C3E88D;">style.innerHTML = </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#A6ACCD;">(code)</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C3E88D;">document.head.appendChild(style)</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">module.exports</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> transform</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">code </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./css-loader.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)(code)</span></span>
<span class="line"><span style="color:#A6ACCD;">code </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./style-loader.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)(code)</span></span>
<span class="line"><span style="color:#A6ACCD;">但这样的话，最后打包输出的结果</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> str </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">const str = </span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">body{color: red}</span><span style="color:#A6ACCD;">\\&quot;\\&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">style</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">innerHTML </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">const str = </span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">body{color: red}</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">...</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">输出的了多余的代码，这样就会有问题</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="源码-学习" tabindex="-1">源码 学习 <a class="header-anchor" href="#源码-学习" aria-hidden="true">#</a></h2><p>不推荐直接看源码，</p><p>先想一次，大胆假设，知道大概原理，带着问题看源码。</p><p>style-loader的源码难，没看懂课程。但没必要花很多时间在这里，技术比较小众。</p><p>webpack-cli的调试</p><ol><li><p>node 命令行窗口直接调试</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">node_modules</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">bin</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli 对src目录进行打包</span></span>
<span class="line"><span style="color:#A6ACCD;">去</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">bin目录看脚本命令</span></span>
<span class="line"><span style="color:#A6ACCD;">对应执行的哪个文件</span></span>
<span class="line"><span style="color:#A6ACCD;">自己敲的时候要加上 </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">mode</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">production</span></span>
<span class="line"><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">node_modules</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">bin</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">mode</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">development</span></span>
<span class="line"><span style="color:#A6ACCD;">node </span><span style="color:#89DDFF;">./</span><span style="color:#A6ACCD;">mode_modules</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">bin</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">mode</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">development</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>node 执行打包脚本命令对应的js文件，并用chrome进行调试</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">node </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">inspect</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">brk </span><span style="color:#89DDFF;">./</span><span style="color:#A6ACCD;">node_modules</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">bin</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>github下载webpack-cli的源码，用yarn link进行关联</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">1.</span><span style="color:#A6ACCD;"> 单独一个目录：   clone webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli</span></span>
<span class="line"><span style="color:#F78C6C;">2.</span><span style="color:#A6ACCD;"> 设置版本：      git reset </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">hard webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli@</span><span style="color:#F78C6C;">4.2</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F78C6C;">3.</span><span style="color:#A6ACCD;"> 安装依赖：      yarn</span></span>
<span class="line"><span style="color:#F78C6C;">4.</span><span style="color:#A6ACCD;"> 到底下目录才行： cd packages</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">/</span></span>
<span class="line"><span style="color:#F78C6C;">5.</span><span style="color:#A6ACCD;"> 建立关联：      yanr link</span></span>
<span class="line"><span style="color:#F78C6C;">6.</span><span style="color:#A6ACCD;"> 然后到另一个项目用： yran link webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli 进行替换</span></span>
<span class="line"><span style="color:#F78C6C;">7.</span><span style="color:#A6ACCD;"> 可以在下载的源代码底下的 packages</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">bin 去找cli</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js log调试</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ol><h3 id="看源码-带着问题看" tabindex="-1">看源码，带着问题看 <a class="header-anchor" href="#看源码-带着问题看" aria-hidden="true">#</a></h3><ol><li>折叠所有代码;</li><li>声明不看，if不看（旁支），if else 要看，要看那种铁定执行的语句;</li><li>看必定会执行的代码</li></ol><p>遵循这个规则，</p><ol><li>webpack-cli怎么用webpack</li></ol><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">---</span><span style="color:#A6ACCD;"> 文件 </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;"> 方法</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">---</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js </span></span>
<span class="line"><span style="color:#A6ACCD;">runCLI</span></span>
<span class="line"><span style="color:#89DDFF;">---</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">lib</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">bootstrap</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#89DDFF;">---</span><span style="color:#A6ACCD;"> webpack</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">cli</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">js</span></span>
<span class="line"><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;"> run</span></span>
<span class="line"><span style="color:#A6ACCD;">		compiler </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">createCompiler</span><span style="color:#A6ACCD;">(options</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> callback)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;"> createCompiler</span></span>
<span class="line"><span style="color:#A6ACCD;">		compiler </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">webpack</span><span style="color:#A6ACCD;">(options</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> callback)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li><p>webpack如何分析index.js的，分析并收集依赖，打包成一个文件</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> 了一个 Complier，做了一堆初始化，但并没有找到怎么去分析依赖的代码</span></span>
<span class="line"><span style="color:#A6ACCD;">hooks</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">xxx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">call</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">hooks</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">xxx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">call 是什么？</span></span>
<span class="line"><span style="color:#A6ACCD;">Tapable webpack团队为了写webpack而写的一个事件</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">钩子库 监听和触发事件的一个库，发布订阅系统</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">用法：</span></span>
<span class="line"><span style="color:#A6ACCD;">定义一个事件</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">钩子</span></span>
<span class="line"><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">hooks</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">事件名 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SyncHook</span><span style="color:#A6ACCD;">([</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">arg1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">arg2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">监听一个事件</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">钩子</span></span>
<span class="line"><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">hooks</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">事件名</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">tap</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">监听理由</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fn)</span></span>
<span class="line"><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">on</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">click</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> fn)</span></span>
<span class="line"><span style="color:#A6ACCD;">触发一个事件</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">钩子</span></span>
<span class="line"><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">hooks</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">事件名</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">arg1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">arg2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">trigger</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">click</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> data)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li><li><p>webpack的流程是怎么样的， webpack把打包分为几个阶段（几个钩子）</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">需要不断去找钩子和执行函数</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>读取index.js 并分析和收集依赖在哪个阶段</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">webpack只是一个架子，主要是创建了各种插件</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">EntryPlugin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">很难找，性价比不高</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面看源码的总结，看迷糊了，就是一直在找钩子</p><ol><li>使用hooks 把主要阶段固定下来</li><li>插件自己选择阶段做事</li><li>入口是有入口插件 EntryPlugins搞定的</li><li>make - compiler - compilation - entry - dep - module</li><li>目前我们分析到 factory.create这一行</li></ol><p>看源码技巧</p><ol><li>没有技巧，看不懂说明水平不到</li><li>多看几遍，寻找灵感</li></ol><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">_source_ _ast_</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">doBuild runLoaders</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>webpack 用了 acorn第三方库来parse js</p><p>先知道原理 才看得懂 源码</p><h3 id="webpack-装逼指南" tabindex="-1">webpack 装逼指南 <a class="header-anchor" href="#webpack-装逼指南" aria-hidden="true">#</a></h3><ol><li>阅读了webpack 源码</li><li>webpack 使用 Tapable 作为事件中心，将打包分为 env,compile,make sewal,emit等阶段</li><li>在make阶段借助acorn对源码进行了parse</li></ol></li></ol><p>chunk 动态引入的模块用chunk单独一个文件，</p><p>源码暂时还是不读了，太复杂了。</p><h3 id="总结-1" tabindex="-1">总结 <a class="header-anchor" href="#总结-1" aria-hidden="true">#</a></h3><p>主要还是手写一个简单的打包器 这一块流程 熟悉</p><h2 id="plugin" tabindex="-1">Plugin <a class="header-anchor" href="#plugin" aria-hidden="true">#</a></h2><ol><li>webpack流程</li><li>插件：在某两个阶段中间插入进去,考虑在哪个阶段执行</li></ol><p>imagemin-webpack-plugin， clewab-webpack-plugin</p><h3 id="imagemin-webpack-plugin" tabindex="-1">imagemin-webpack-plugin <a class="header-anchor" href="#imagemin-webpack-plugin" aria-hidden="true">#</a></h3><ol><li>使用</li><li>源码，监听emit事件，对compilation.assets进行遍历，如果是图片的话，就对图片进行压缩</li></ol><h3 id="clean-webpack-plugin" tabindex="-1">clean-webpack-plugin <a class="header-anchor" href="#clean-webpack-plugin" aria-hidden="true">#</a></h3><ol><li>使用</li><li>emit，确定开始编译之前，清除之前的文件</li><li>done，删除不需要的临时文件</li></ol><h3 id="provideplugin" tabindex="-1">providePlugin <a class="header-anchor" href="#provideplugin" aria-hidden="true">#</a></h3><p>全局使用一个变量，不需要引入，直接用就好了，会自动在使用到变量的文件自动引入。</p><p>在哪个阶段开始做呢？</p><p>该 插件直接监听的是nmf</p><p>compilation阶段，获取nmf, parse之后, 在ast遍历的时候进行处理</p><h3 id="loader-和-plugin区别" tabindex="-1">Loader 和 plugin区别 ？ <a class="header-anchor" href="#loader-和-plugin区别" aria-hidden="true">#</a></h3><p>loader主要是在make阶段</p><p>plugin对webpack的每个阶段进行介入，丰富webpack的能力，基于事件机制工作，监听web pack的 打包过程中每个阶段函数</p><h3 id="自己写webpack-plugin" tabindex="-1">自己写webpack plugin <a class="header-anchor" href="#自己写webpack-plugin" aria-hidden="true">#</a></h3><p>官方文档 write plugin</p><p>主要是按照官方文档格式，以及考虑需求，要监听什么阶段的事件？，以及要做什么？</p><p>主要用到的知识：</p><ol><li>webpack hooks</li><li>编译原理的了解</li><li>对chunk 、hash、 module、 dep、 factory等的理解</li></ol>`,111),o=[e];function r(c,t,i,D,y,C){return a(),n("div",null,o)}const b=s(p,[["render",r]]);export{F as __pageData,b as default};
